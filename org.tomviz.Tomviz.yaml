app-id: org.tomviz.Tomviz
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: '5.15'
command: tomviz
#For CastXML
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm11
# GLEW does not support Wayland yet.
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --filesystem=home
cleanup:
  - /bin/papraview
  - /include
  - /lib/cmake
  - /share/doc
  - /share/castxml
  - '*.la'
  - '*.a'

modules:
  - shared-modules/glew/glew.json
  - shared-modules/linux-audio/fftw3f.json

    #cmake-ninja does not work
  - name: CastXML
    buildsystem: cmake
    config-opts:
      - -DCLANG_LINK_CLANG_DYLIB:BOOL=ON
      - -DLLVM_DIR=/usr/lib/sdk/llvm11/lib/cmake/llvm
    sources:
      - type: archive
        url: https://github.com/CastXML/CastXML/archive/v0.6.8.tar.gz
        sha256: b517a9d18ddb7f71b3b053af61fc393dd81f17911e6c6d53a85f3f523ba8ad64
        x-checker-data:
          type: anitya
          project-id: 9347
          stable-only: true
          url-template: https://github.com/CastXML/CastXML/archive/v$version.tar.gz
    cleanup:
      - /lib/cmake

  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'

  - name: lapack
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DLAPACKE=ON
      - -DCBLAS=ON
    sources:
      - type: archive
        url: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v3.12.0.tar.gz
        sha256: eac9570f8e0ad6f30ce4b963f4f033f0f643e7c3912fc9ee6cd99120675ad48b
        x-checker-data:
          type: anitya
          project-id: 1534
          stable-only: true
          url-template: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v$version.tar.gz
    cleanup:
      - /lib/cmake

  - name: pybind11
    buildsystem: simple
    build-commands:
      - python3.8 setup.py build
      - cmake -DPYBIND11_INSTALL=ON -DPYBIND11_TEST=OFF .
      - cmake --build .
      - python3.8 setup.py install --skip-build --force --prefix=/app
    sources:
      - type: archive
        url: https://github.com/pybind/pybind11/archive/v2.6.2.tar.gz
        sha256: 8ff2fff22df038f5cd02cea8af56622bc67f5b64534f1b83b9f133b8366acff2

  - name: python-numpy
    buildsystem: simple
    build-commands:
      - rm pyproject.toml
      - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/25/ca/1166b75c21abd1da445b97bf1fa2f14f423c6cfb4fc7c4ef31dccf9f6a94/numpy-2.1.3.tar.gz
        sha256: aa08e04e08aaf974d4458def539dece0d28146d866a39da5639596f4921fd761
        x-checker-data:
          type: pypi
          name: numpy

  - name: python-scipy
    buildsystem: simple
    build-commands:
      - python3 setup.py build -j 0
      - python3 setup.py install --prefix=/app --root=/ --optimize=1
    build-options:
      env:
        ATLAS: None
        BLAS: /app/lib
        LAPACK: /app/lib
        LDFLAGS: -shared
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/62/11/4d44a1f274e002784e4dbdb81e0ea96d2de2d1045b2132d5af62cc31fd28/scipy-1.14.1.tar.gz
        sha256: 5a275584e726026a5699459aa72f828a610821006228e841b94275c4a7c08417
        x-checker-data:
          type: pypi
          name: scipy
    modules:
      - name: python-gast
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/3c/14/c566f5ca00c115db7725263408ff952b8ae6d6a4e792ef9c84e77d9af7a1/gast-0.6.0.tar.gz
            sha256: 88fc5300d32c7ac6ca7b515310862f71e6fdf2c029bbec7c66c0f5dd47b6b1fb
            x-checker-data:
              type: pypi
              name: gast
      - name: python-pythran
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/c6/e6/986a967dcca91d89e36f4d4a2f69a052030bce01a7cd48a6b7fba1a50189/pythran-0.9.12.post1.tar.gz
            sha256: e7589cf83b0befa9a1b55e98223caf89aff887d9e3f14be912cf8703a717f185
          - type: patch
            path: remove_pytest-runner.patch
            x-checker-data:
              type: pypi
              name: pythran
      - name: python-beniget
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/2e/27/5bb01af8f2860d431b98d0721b96ff2cea979106cae3f2d093ec74f6400c/beniget-0.4.2.post1.tar.gz
            sha256: a0258537e65e7e14ec33a86802f865a667f949bb6c73646d55e42f7c45a052ae
            x-checker-data:
              type: pypi
              name: beniget
      - name: python-ply
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/e5/69/882ee5c9d017149285cab114ebeab373308ef0f874fcdac9beb90e0ac4da/ply-3.11.tar.gz
            sha256: 00c7c1aaa88358b9c765b6d3000c6eec0ba42abca5351b095321aef446081da3
            x-checker-data:
              type: pypi
              name: ply

  - name: python-FFTW
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/4b/3f/ee1bc44b080fc1e81d293cd07bed563d254bc1997d63a3b8053804a87dfd/pyfftw-0.15.0.tar.gz
        sha256: 2f16b9854a40c8fdd10aa5803b24ddc6ab49f9cd559dbd7f07e7d61aa205c1ca
        x-checker-data:
          type: pypi
          name: pyFFTW

  - name: TBB
    buildsystem: cmake
    builddir: true
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v2022.0.0.tar.gz
        sha256: e8e89c9c345415b17b30a2db3095ba9d47647611662073f7fbf54ad48b7f3c2a
        x-checker-data:
          type: anitya
          project-id: 227581
          stable-only: true
          url-template: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v$version.tar.gz

  - name: SWIG
    config-opts:
      - --without-pcre
      - --disable-ccache
      - --without-tcl
      - --without-tcl
      - --without-perl5
      - --without-octave
      - --without-scilab
      - --without-java
      - --without-ruby
    sources:
      - type: archive
        url: https://sourceforge.net/projects/swig/files/swig/swig-4.3.0/swig-4.3.0.tar.gz
        sha256: f7203ef796f61af986c70c05816236cbd0d31b7aa9631e5ab53020ab7804aa9e
        x-checker-data:
          type: anitya
          project-id: 4919
          stable-only: true
          url-template: https://sourceforge.net/projects/swig/files/swig/swig-$version/swig-$version.tar.gz
    cleanup:
      - /share

  - name: gdcm
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DGDCM_BUILD_APPLICATIONS=OFF
      - -DGDCM_BUILD_SHARED_LIBS=ON
      - -DCMAKE_BUILD_TYPE=Release
      - -DGDCM_WRAP_PYTHON=ON
      - -DPYTHON_EXECUTABLE=/usr/bin/python3
      - -DGDCM_INSTALL_PYTHONMODULE_DIR=/app/lib/python3.8/site-packages/
      - -DGDCM_USE_VTK=OFF
      - -DGDCM_BUILD_DOCBOOK_MANPAGES:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/malaterre/GDCM/archive/v3.0.24.tar.gz
        sha256: d88519a094797c645ca34797a24a14efc10965829c4c3352c8ef33782a556336
        x-checker-data:
          type: anitya
          project-id: 883
          stable-only: true
          url-template: https://github.com/malaterre/GDCM/archive/v$version.tar.gz
    cleanup:
      - /bin

    #Paraview need 32GB of memory to build
    # ParaView does not support ARM CPU yet.
  - name: OpenChemistry-Paraview
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DPARAVIEW_BUILD_QT_GUI:BOOL=ON
      - -DPARAVIEW_ENABLE_QT_SUPPORT:BOOL=ON
      - -DPARAVIEW_BUILD_SHARED_LIBS:BOOL=ON
      - -DPARAVIEW_BUILD_TESTING:BOOL=OFF
      - -DVTK_PYTHON_FULL_THREADSAFE:BOOL=ON
      - -DVTK_NO_PYTHON_THREADS:BOOL=OFF
      - -DPARAVIEW_USE_PYTHON:BOOL=ON
      - -DPARAVIEW_ENABLE_COMMANDLINE_TOOLS:BOOL=OFF
      - -DPARAVIEW_ENABLE_WEB:BOOL=ON
      - -DPARAVIEW_USE_QTHELP:BOOL=OFF
      - -DPARAVIEW_USE_VTKM:BOOL=OFF
      - -DPARAVIEW_PLUGINS_DEFAULT:BOOL=OFF
      - -DPARAVIEW_ENABLE_KITS:BOOL=ON
      - -DPARAVIEW_ENABLE_FFMPEG:BOOL=ON
      - -DCMAKE_CXX_STANDARD:STRING=11
      - -DCMAKE_CXX_STANDARD_REQUIRED:BOOL=ON
      - -DPARAVIEW_ENABLE_LOOKINGGLASS:BOOL=OFF
      - -DPARAVIEW_PLUGIN_ENABLE_LookingGlass:BOOL=OFF
      #- -DVTK_SMP_IMPLEMENTATION_TYPE:STRING=${VTK_SMP_IMPLEMENTATION_TYPE}
      #- -DHoloPlayCore_INCLUDE_DIR:PATH=${HoloPlayCore_INCLUDE_DIR}
      #- -DHoloPlayCore_LIBRARY:PATH=${HoloPlayCore_LIBRARY}
      - -DCMAKE_INSTALL_NAME_DIR=/app/lib
    post-install:
      - rm -r ${FLATPAK_DEST}/share/icons/hicolor/*/apps/paraview.png
      - rm -r ${FLATPAK_DEST}/share/applications/org.paraview.ParaView.desktop
    sources:
      - type: archive
        url: https://www.paraview.org/files/v5.9/ParaView-v5.9.0.tar.gz
        sha256: f96c9c996903b295dcfb7db689411d1d0e6a3ccaeb6935c70deb8cc9e5e657c6
        # There is issue with flathub bot not able to clone paraview fork from openchemistry.
        # https://github.com/flathub/backend/issues/50
        # So use upstream paraview and apply any change with patch.
      #- type: patch
        #path: apply-openchemistry-paraview.patch

  - name: ITK
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE:STRING=Release
      - -DITK_LEGACY_REMOVE:BOOL=ON
      - -DITK_LEGACY_SILENT:BOOL=ON
      - -DModule_ITKBridgeNumPy:BOOL=ON
      - -DBUILD_TESTING:BOOL=OFF
      - -DITK_WRAP_unsigned_short:BOOL=ON
      - -DITK_WRAP_rgb_unsigned_char:BOOL=OFF
      - -DITK_WRAP_rgba_unsigned_char:BOOL=OFF
      - -DITK_BUILD_DEFAULT_MODULES:BOOL=OFF
      - -DITKGroup_Core:BOOL=ON
      - -DITKGroup_Filtering:BOOL=ON
      - -DITKGroup_Segmentation:BOOL=ON
      - -DITKGroup_Nonunit:BOOL=ON
      - -DPython_ADDITIONAL_VERSIONS:STRING=3
      - -DITK_WRAP_PYTHON:BOOL=ON
      - -DBUILD_EXAMPLES:BOOL=OFF
      - -DBUILD_SHARED_LIBS:BOOL=ON
      - -DITK_USE_SYSTEM_LIBRARIES:BOOL=ON
      - -DITK_USE_SYSTEM_CASTXML:BOOL=ON
      - -DITK_USE_SYSTEM_GDCM:BOOL=ON
      - -DITK_USE_SYSTEM_SWIG:BOOL=ON
      - -DITK_USE_SYSTEM_VXL:BOOL=OFF
      - -DITK_FORBID_DOWNLOADS=ON
    sources:
      - type: archive
        url: https://github.com/InsightSoftwareConsortium/ITK/archive/refs/tags/v6.0a01.tar.gz
        sha256: 52e14661d0fa3b38fb34d43f93bc33edd35ff0b96b922baea90f77206a00494e
        x-checker-data:
          type: anitya
          project-id: 223473
          stable-only: true
          url-template: https://github.com/InsightSoftwareConsortium/ITK/archive/refs/tags/v$version.tar.gz

  - name: Tomviz
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE:STRING=Release
    sources:
      - type: archive
        url: https://github.com/OpenChemistry/tomviz/releases/download/1.10.0/tomviz-1.10.0.tar.gz
        sha256: be7510dd5068f30d8334546382b58c4b2e15e04cb60288d29b560f45f6c60209
        x-checker-data:
          type: anitya
          project-id: 223480
          stable-only: true
          url-template: https://github.com/OpenChemistry/tomviz/releases/download/$version/tomviz-$version.tar.gz

  - name: Tomviz-metainfo-desktopfile-icon
    buildsystem: simple
    build-commands:
      - install -Dm0644 $FLATPAK_ID.metainfo.xml ${FLATPAK_DEST}/share/metainfo/$FLATPAK_ID.metainfo.xml
      - install -Dm0644 $FLATPAK_ID.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/$FLATPAK_ID.png
      - install -Dm0644 $FLATPAK_ID.desktop ${FLATPAK_DEST}/share/applications/$FLATPAK_ID.desktop
    sources:
      - type: file
        path: org.tomviz.Tomviz.metainfo.xml
      - type: file
        path: org.tomviz.Tomviz.png
      - type: file
        path: org.tomviz.Tomviz.desktop
