app-id: org.tomviz.Tomviz
runtime: org.kde.Platform
sdk: org.kde.Sdk
runtime-version: 5.15-22.08
command: tomviz
#For CastXML
sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm14
# GLEW does not support Wayland yet.
finish-args:
  - --share=ipc
  - --socket=x11
  - --device=dri
  - --filesystem=home
cleanup:
  - /bin/papraview
  - /include
  - /lib/cmake
  - /share/doc
  - /share/castxml
  - '*.la'
  - '*.a'

modules:
  - shared-modules/glew/glew.json
  - shared-modules/linux-audio/fftw3f.json

    #cmake-ninja does not work
  - name: CastXML
    buildsystem: cmake
    config-opts:
      - -DCLANG_LINK_CLANG_DYLIB:BOOL=ON
      - -DLLVM_DIR=/usr/lib/sdk/llvm14/lib/cmake/llvm
    sources:
      - type: archive
        url: https://github.com/CastXML/CastXML/archive/v0.4.7.tar.gz
        sha256: 09f3b6df6a620ce5efdc6746cba7a337e9dd6503553814e82de20cb39c0d0ba9
        x-checker-data:
          type: anitya
          project-id: 9347
          stable-only: true
          url-template: https://github.com/CastXML/CastXML/archive/v$version.tar.gz
    cleanup:
      - /lib/cmake

  - name: Eigen3
    buildsystem: cmake-ninja
    builddir: true
    sources:
      - type: archive
        url: https://gitlab.com/libeigen/eigen/-/archive/3.4.0/eigen-3.4.0.tar.bz2
        sha256: b4c198460eba6f28d34894e3a5710998818515104d6e74e5cc331ce31e46e626
        x-checker-data:
          type: anitya
          project-id: 13751
          stable-only: true
          url-template: https://gitlab.com/libeigen/eigen/-/archive/$version/eigen-$version.tar.bz2
    cleanup:
      - '*'

  - name: lapack
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=Release
      - -DBUILD_SHARED_LIBS=ON
      - -DBUILD_TESTING=OFF
      - -DLAPACKE=ON
      - -DCBLAS=ON
    sources:
      - type: archive
        url: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v3.11.tar.gz
        sha256: 5a5b3bac27709d8c66286b7a0d1d7bf2d7170ec189a1a756fdf812c97aa7fd10
        # x-checker-data:
        #   type: anitya
        #   project-id: 1534
        #   stable-only: true
        #   url-template: https://github.com/Reference-LAPACK/lapack/archive/refs/tags/v$version.tar.gz
    cleanup:
      - /lib/cmake

  - name: openblas
    no-autogen: true
    make-args:
      - DYNAMIC_ARCH=1
      - DYNAMIC_OLDER=1
      - FC=gfortran
      - NO_CBLAS=1
      - NO_LAPACKE=1
      - TARGET=GENERIC
      - USE_OPENMP=0    ## OpenMP off by default, this hack skips 'test_fork' which crashes on i386
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/xianyi/OpenBLAS/archive/v0.3.21.tar.gz
        sha256: f36ba3d7a60e7c8bcc54cd9aaa9b1223dd42eaf02c811791c37e8ca707c241ca
        x-checker-data:
          type: anitya
          project-id: 2540
          url-template: https://github.com/xianyi/OpenBLAS/archive/v$version.tar.gz

  - name: pybind11
    buildsystem: simple
    build-commands:
      - python3 -mpip install . --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation
    sources:
      - type: archive
        url: https://github.com/pybind/pybind11/archive/v2.10.1.tar.gz
        sha256: 111014b516b625083bef701df7880f78c2243835abdb263065b6b59b960b6bad
        x-checker-data:
          type: anitya
          project-id: 13384
          stable-only: true
          url-template: https://github.com/pybind/pybind11/archive/v$version.tar.gz

  - name: python-numpy
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/64/8e/9929b64e146d240507edaac2185cd5516f00b133be5b39250d253be25a64/numpy-1.23.4.tar.gz
        sha256: ed2cc92af0efad20198638c69bb0fc2870a58dabfba6eb722c933b48556c686c
        x-checker-data:
          type: pypi
          name: numpy

  - python-deps.json

  - name: python-scipy
    buildsystem: simple
    build-commands:
      - python3 -mpip install . --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST}
        --no-build-isolation
    build-options:
      env:
        ATLAS: None
        BLAS: /app/lib
        LAPACK: /app/lib
        LDFLAGS: -shared
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/0a/2e/44795c6398e24e45fa0bb61c3e98de1cfea567b1b51efd3751e2f7ff9720/scipy-1.9.3.tar.gz
        sha256: fbc5c05c85c1a02be77b1ff591087c83bc44579c6d2bd9fb798bb64ea5e1a027
        x-checker-data:
          type: pypi
          name: scipy
    modules:
      - name: meson-python
        buildsystem: simple
        build-commands:
          - python3 -mpip install . --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} --no-build-isolation
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/09/51/600a029573c775081d5145fd1b09d22a8d9e73671d84792534f491f38fef/meson_python-0.12.0.tar.gz
            sha256: 8cb159a8093a2e73cfa897f8092ec93b74e3842f94dff7fde381c6fe0e0b064d
            x-checker-data:
              type: pypi
              name: meson-python
      - name: python-gast
        buildsystem: simple
        build-commands:
          - python3 -mpip install . --no-index --find-links=file://${PWD} --prefix=${FLATPAK_DEST} --no-build-isolation
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/48/a3/0bd844c54ae8141642088b7ae09dd38fec2ec7faa9b7d25bb6a23c1f266f/gast-0.5.3.tar.gz
            sha256: cfbea25820e653af9c7d1807f659ce0a0a9c64f2439421a7bba4f0983f532dea
            x-checker-data:
              type: pypi
              name: gast
      - name: python-pythran
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/c6/e6/986a967dcca91d89e36f4d4a2f69a052030bce01a7cd48a6b7fba1a50189/pythran-0.9.12.post1.tar.gz
            sha256: e7589cf83b0befa9a1b55e98223caf89aff887d9e3f14be912cf8703a717f185
          - type: patch
            path: remove_pytest-runner.patch
            x-checker-data:
              type: pypi
              name: pythran
      - name: python-beniget
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/14/e7/50cbac38f77eca8efd39516be6651fdb9f3c4c0fab8cf2cf05f612578737/beniget-0.4.1.tar.gz
            sha256: 75554b3b8ad0553ce2f607627dad3d95c60c441189875b98e097528f8e23ac0c
            x-checker-data:
              type: pypi
              name: beniget
      - name: python-ply
        buildsystem: simple
        build-commands:
          - python3 setup.py install --prefix=${FLATPAK_DEST} --root=/ --optimize=1
        sources:
          - type: archive
            url: https://files.pythonhosted.org/packages/e5/69/882ee5c9d017149285cab114ebeab373308ef0f874fcdac9beb90e0ac4da/ply-3.11.tar.gz
            sha256: 00c7c1aaa88358b9c765b6d3000c6eec0ba42abca5351b095321aef446081da3
            x-checker-data:
              type: pypi
              name: ply

  - name: python-FFTW
    buildsystem: simple
    build-commands:
      - python3 setup.py install --prefix=/app --root=/ --optimize=1
    sources:
      - type: archive
        url: https://files.pythonhosted.org/packages/18/a1/5eb99c183af0a49bf632fed3260a6cad3f7978bb19fd661a573d3728a986/pyFFTW-0.13.0.tar.gz
        sha256: da85102405c0bd95d57eb19e99b01a0729d8406cb204c3900894b873784253da
        x-checker-data:
          type: pypi
          name: pyFFTW

  - name: TBB
    buildsystem: cmake
    builddir: true
    sources:
      - type: archive
        url: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v2021.7.0.tar.gz
        sha256: 2cae2a80cda7d45dc7c072e4295c675fff5ad8316691f26f40539f7e7e54c0cc
        x-checker-data:
          type: anitya
          project-id: 227581
          stable-only: true
          url-template: https://github.com/oneapi-src/oneTBB/archive/refs/tags/v$version.tar.gz

  - name: SWIG
    config-opts:
      - --without-pcre
      - --disable-ccache
      - --without-tcl
      - --without-tcl
      - --without-perl5
      - --without-octave
      - --without-scilab
      - --without-java
      - --without-ruby
    sources:
      - type: archive
        url: https://sourceforge.net/projects/swig/files/swig/swig-4.1.0/swig-4.1.0.tar.gz
        sha256: d6a9a8094e78f7cfb6f80a73cc271e1fe388c8638ed22668622c2c646df5bb3d
        x-checker-data:
          type: anitya
          project-id: 4919
          stable-only: true
          url-template: https://sourceforge.net/projects/swig/files/swig/swig-$version/swig-$version.tar.gz
    cleanup:
      - /share

  - name: gdcm
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DGDCM_BUILD_APPLICATIONS=OFF
      - -DGDCM_BUILD_SHARED_LIBS=ON
      - -DCMAKE_BUILD_TYPE=Release
      - -DGDCM_WRAP_PYTHON=ON
      - -DPYTHON_EXECUTABLE=/usr/bin/python3
      - -DGDCM_INSTALL_PYTHONMODULE_DIR=/app/lib/python3.8/site-packages/
      - -DGDCM_USE_VTK=OFF
      - -DGDCM_BUILD_DOCBOOK_MANPAGES:BOOL=OFF
    sources:
      - type: archive
        url: https://github.com/malaterre/GDCM/archive/v3.0.20.tar.gz
        sha256: 18161bd76008f4e8a0a33dab72fa34684147e8164f25a4735f373ad4bd909636
        x-checker-data:
          type: anitya
          project-id: 883
          stable-only: true
          url-template: https://github.com/malaterre/GDCM/archive/v$version.tar.gz
    cleanup:
      - /bin

    #Paraview need 32GB of memory to build
    # ParaView does not support ARM CPU yet.
  - name: OpenChemistry-Paraview
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DPARAVIEW_BUILD_QT_GUI:BOOL=ON
      - -DPARAVIEW_ENABLE_QT_SUPPORT:BOOL=ON
      - -DPARAVIEW_BUILD_SHARED_LIBS:BOOL=ON
      - -DPARAVIEW_BUILD_TESTING:BOOL=OFF
      - -DVTK_PYTHON_FULL_THREADSAFE:BOOL=ON
      - -DVTK_NO_PYTHON_THREADS:BOOL=OFF
      - -DPARAVIEW_USE_PYTHON:BOOL=ON
      - -DPARAVIEW_ENABLE_COMMANDLINE_TOOLS:BOOL=OFF
      - -DPARAVIEW_ENABLE_WEB:BOOL=ON
      - -DPARAVIEW_USE_QTHELP:BOOL=OFF
      - -DPARAVIEW_USE_VTKM:BOOL=OFF
      - -DPARAVIEW_PLUGINS_DEFAULT:BOOL=OFF
      - -DPARAVIEW_ENABLE_KITS:BOOL=ON
      - -DPARAVIEW_ENABLE_FFMPEG:BOOL=ON
      - -DCMAKE_CXX_STANDARD:STRING=11
      - -DCMAKE_CXX_STANDARD_REQUIRED:BOOL=ON
      - -DPARAVIEW_ENABLE_LOOKINGGLASS:BOOL=OFF
      - -DPARAVIEW_PLUGIN_ENABLE_LookingGlass:BOOL=OFF
      #- -DVTK_SMP_IMPLEMENTATION_TYPE:STRING=${VTK_SMP_IMPLEMENTATION_TYPE}
      #- -DHoloPlayCore_INCLUDE_DIR:PATH=${HoloPlayCore_INCLUDE_DIR}
      #- -DHoloPlayCore_LIBRARY:PATH=${HoloPlayCore_LIBRARY}
      - -DCMAKE_INSTALL_NAME_DIR=/app/lib
    post-install:
      - rm -r ${FLATPAK_DEST}/share/icons/hicolor/*/apps/paraview.png
      - rm -r ${FLATPAK_DEST}/share/applications/org.paraview.ParaView.desktop
    sources:
      - type: archive
        url: https://www.paraview.org/files/v5.9/ParaView-v5.9.0.tar.gz
        sha256: f96c9c996903b295dcfb7db689411d1d0e6a3ccaeb6935c70deb8cc9e5e657c6
        # There is issue with flathub bot not able to clone paraview fork from openchemistry.
        # https://github.com/flathub/backend/issues/50
        # So use upstream paraview and apply any change with patch.
      #- type: patch
        #path: apply-openchemistry-paraview.patch

  - name: ITK
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE:STRING=Release
      - -DITK_LEGACY_REMOVE:BOOL=ON
      - -DITK_LEGACY_SILENT:BOOL=ON
      - -DModule_ITKBridgeNumPy:BOOL=ON
      - -DBUILD_TESTING:BOOL=OFF
      - -DITK_WRAP_unsigned_short:BOOL=ON
      - -DITK_WRAP_rgb_unsigned_char:BOOL=OFF
      - -DITK_WRAP_rgba_unsigned_char:BOOL=OFF
      - -DITK_BUILD_DEFAULT_MODULES:BOOL=OFF
      - -DITKGroup_Core:BOOL=ON
      - -DITKGroup_Filtering:BOOL=ON
      - -DITKGroup_Segmentation:BOOL=ON
      - -DITKGroup_Nonunit:BOOL=ON
      - -DPython_ADDITIONAL_VERSIONS:STRING=3
      - -DITK_WRAP_PYTHON:BOOL=ON
      - -DBUILD_EXAMPLES:BOOL=OFF
      - -DBUILD_SHARED_LIBS:BOOL=ON
      - -DITK_USE_SYSTEM_LIBRARIES:BOOL=ON
      - -DITK_USE_SYSTEM_CASTXML:BOOL=ON
      - -DITK_USE_SYSTEM_GDCM:BOOL=ON
      - -DITK_USE_SYSTEM_SWIG:BOOL=ON
      - -DITK_USE_SYSTEM_VXL:BOOL=OFF
      - -DITK_FORBID_DOWNLOADS=ON
    sources:
      - type: archive
        url: https://github.com/InsightSoftwareConsortium/ITK/archive/refs/tags/v5.2.1.tar.gz
        sha256: 6022b2b64624b8bcec3333fe48d5f74ff6ebceb3bdf98258ba7d7fbbc76b99ab
        x-checker-data:
          type: anitya
          project-id: 223473
          stable-only: true
          url-template: https://github.com/InsightSoftwareConsortium/ITK/archive/refs/tags/v$version.tar.gz

  - name: Tomviz
    buildsystem: cmake
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE:STRING=Release
    sources:
      - type: archive
        url: https://github.com/OpenChemistry/tomviz/releases/download/1.10.0/tomviz-1.10.0.tar.gz
        sha256: be7510dd5068f30d8334546382b58c4b2e15e04cb60288d29b560f45f6c60209
        x-checker-data:
          type: anitya
          project-id: 223480
          stable-only: true
          url-template: https://github.com/OpenChemistry/tomviz/releases/download/$version/tomviz-$version.tar.gz

  - name: Tomviz-metainfo-desktopfile-icon
    buildsystem: simple
    build-commands:
      - install -Dm0644 $FLATPAK_ID.metainfo.xml ${FLATPAK_DEST}/share/metainfo/$FLATPAK_ID.metainfo.xml
      - install -Dm0644 $FLATPAK_ID.png ${FLATPAK_DEST}/share/icons/hicolor/128x128/apps/$FLATPAK_ID.png
      - install -Dm0644 $FLATPAK_ID.desktop ${FLATPAK_DEST}/share/applications/$FLATPAK_ID.desktop
    sources:
      - type: file
        path: org.tomviz.Tomviz.metainfo.xml
      - type: file
        path: org.tomviz.Tomviz.png
      - type: file
        path: org.tomviz.Tomviz.desktop
